<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinOrb: Privacy-First Financial Health Dashboard</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: var(--gray-700);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      width: 100%;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--gray-200);
      padding-bottom: 20px;
    }
    
    h1 {
      color: var(--primary);
      font-size: 2.5rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .tagline {
      color: var(--gray-500);
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    
    @media (max-width: 900px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
    }
    
    .input-section, .visualization-section {
      background: var(--gray-50);
      border-radius: 16px;
      padding: 25px;
    }
    
    .section-title {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .input-group {
      margin: 18px 0;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--gray-700);
    }
    
    input {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      transition: all 0.2s;
    }
    
    button:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      color: var(--gray-500);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    #orb-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 30px 0;
    }
    
    #orb {
      width: 300px;
      height: 300px;
      margin: 0 auto;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .metric-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      text-align: center;
    }
    
    .metric-value {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 8px 0;
    }
    
    .metric-good {
      color: var(--success);
    }
    
    .metric-warning {
      color: var(--warning);
    }
    
    .metric-danger {
      color: var(--danger);
    }
    
    .metric-label {
      font-size: 0.85rem;
      color: var(--gray-500);
    }
    
    .insights {
      margin-top: 25px;
    }
    
    .insight-card {
      background: white;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-left: 4px solid var(--primary);
    }
    
    .insight-title {
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .share-section {
      margin-top: 30px;
      text-align: center;
    }
    
    .share-url {
      background: var(--gray-100);
      padding: 14px;
      border-radius: 10px;
      font-family: monospace;
      word-break: break-all;
      margin-top: 15px;
      border: 1px dashed var(--gray-300);
    }
    
    .privacy-note {
      text-align: center;
      color: var(--gray-500);
      font-size: 14px;
      margin-top: 30px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .goal-form {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .goal-form input {
      flex: 1;
    }
    
    .goal-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .goal-progress {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .goal-progress-bar {
      height: 100%;
      background: var(--success);
      border-radius: 4px;
      transition: width 0.5s;
    }
    
    .history-chart {
      height: 200px;
      margin-top: 20px;
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .footer {
      text-align: center;
      color: var(--gray-500);
      font-size: 0.9rem;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--gray-200);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîí FinOrb</h1>
      <p class="tagline">Your privacy-first financial health dashboard. All calculations happen on your device‚Äîno data is ever sent to servers.</p>
    </header>
    
    <div class="dashboard">
      <div class="input-section">
        <h2 class="section-title">üìä Your Financial Snapshot</h2>
        
        <div class="input-group">
          <label for="income">Monthly Income ($)</label>
          <input type="number" id="income" placeholder="e.g., 5000">
        </div>
        
        <div class="input-group">
          <label for="expenses">Monthly Expenses ($)</label>
          <input type="number" id="expenses" placeholder="e.g., 3500">
        </div>
        
        <div class="input-group">
          <label for="debt">Total Debt ($)</label>
          <input type="number" id="debt" placeholder="e.g., 20000">
        </div>
        
        <div class="input-group">
          <label for="savings">Emergency Savings ($)</label>
          <input type="number" id="savings" placeholder="e.g., 10000">
        </div>
        
        <div class="input-group">
          <label for="investments">Investments ($)</label>
          <input type="number" id="investments" placeholder="e.g., 15000">
        </div>
        
        <button onclick="generateOrb()">Generate Financial Orb</button>
        <button onclick="saveSnapshot()" style="background: var(--success);">Save Snapshot</button>
      </div>
      
      <div class="visualization-section">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('orb')">Financial Orb</div>
          <div class="tab" onclick="switchTab('goals')">Goals</div>
          <div class="tab" onclick="switchTab('history')">History</div>
        </div>
        
        <div id="orb-tab" class="tab-content active">
          <div id="orb-container">
            <div id="orb"></div>
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-label">Savings Rate</div>
                <div id="savings-rate" class="metric-value">--%</div>
                <div class="metric-label">Target: >20%</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Debt-to-Income</div>
                <div id="dti-ratio" class="metric-value">--%</div>
                <div class="metric-label">Target: <36%</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Emergency Fund</div>
                <div id="emergency-months" class="metric-value">-- mo</div>
                <div class="metric-label">Target: 3-6 mo</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Net Worth</div>
                <div id="net-worth" class="metric-value">$--</div>
                <div class="metric-label">Growing!</div>
              </div>
            </div>
          </div>
          
          <div class="insights">
            <h3 class="section-title">üí° Financial Insights</h3>
            <div id="insights-container">
              <div class="insight-card">
                <div class="insight-title">üìà Start Tracking</div>
                <p>Enter your financial details to get personalized insights and recommendations.</p>
              </div>
            </div>
          </div>
        </div>
        
        <div id="goals-tab" class="tab-content">
          <h3 class="section-title">üéØ Financial Goals</h3>
          <div class="goal-form">
            <input type="text" id="goal-input" placeholder="e.g., Save $5000 for vacation">
            <button onclick="addGoal()" style="width: auto;">Add Goal</button>
          </div>
          <div id="goals-container"></div>
        </div>
        
        <div id="history-tab" class="tab-content">
          <h3 class="section-title">üìà Financial History</h3>
          <p>Track your financial progress over time. Data is stored locally in your browser.</p>
          <div class="history-chart" id="history-chart">
            <canvas id="trend-chart"></canvas>
          </div>
          <button onclick="clearHistory()" style="width: auto; background: var(--danger); margin-top: 15px;">Clear History</button>
        </div>
      </div>
    </div>
    
    <div class="share-section">
      <h3 class="section-title">üîó Share Your Financial DNA</h3>
      <p>Share a privacy-safe version of your financial health without revealing any actual numbers.</p>
      <div id="shareUrl" class="share-url" style="display:none;"></div>
      <button onclick="shareDNA()" style="width: auto; margin-top: 15px;">Generate Shareable Link</button>
    </div>
    
    <p class="privacy-note">
      ‚ú® <strong>Your privacy is protected:</strong> All calculations happen in your browser. 
      No financial data is ever transmitted to servers. The shareable link contains only a 
      privacy-safe hash that cannot be reversed to reveal your actual financial details.
    </p>
  </div>
  
  <div class="footer">
    <p>FinOrb &copy; 2023 | Privacy-First Financial Health</p>
  </div>

  <script>
    // Financial data and state
    let financialData = {
      income: 0,
      expenses: 0,
      debt: 0,
      savings: 0,
      investments: 0
    };
    
    let goals = [];
    let history = [];
    
    // DOM elements
    const orbElement = document.getElementById('orb');
    const savingsRateElement = document.getElementById('savings-rate');
    const dtiRatioElement = document.getElementById('dti-ratio');
    const emergencyMonthsElement = document.getElementById('emergency-months');
    const netWorthElement = document.getElementById('net-worth');
    const insightsContainer = document.getElementById('insights-container');
    const goalsContainer = document.getElementById('goals-container');
    const goalInput = document.getElementById('goal-input');
    const shareUrlElement = document.getElementById('shareUrl');
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      loadFromStorage();
      renderGoals();
      renderHistoryChart();
      
      // Check for shared DNA in URL
      const urlParams = new URLSearchParams(window.location.hash.substring(1));
      if (urlParams.get('dna')) {
        renderSharedDNA(urlParams.get('dna'));
      }
    });
    
    // Tab switching
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Deactivate all tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Activate selected tab
      document.getElementById(`${tabName}-tab`).classList.add('active');
      event.target.classList.add('active');
    }
    
    // Generate the financial orb visualization
    function generateOrb() {
      // Get and validate inputs
      financialData.income = parseFloat(document.getElementById('income').value) || 0;
      financialData.expenses = parseFloat(document.getElementById('expenses').value) || 0;
      financialData.debt = parseFloat(document.getElementById('debt').value) || 0;
      financialData.savings = parseFloat(document.getElementById('savings').value) || 0;
      financialData.investments = parseFloat(document.getElementById('investments').value) || 0;
      
      if (financialData.income <= 0) {
        alert("Please enter a valid income amount.");
        return;
      }
      
      // Calculate financial metrics
      const savingsRate = ((financialData.income - financialData.expenses) / financialData.income) * 100;
      const dtiRatio = (financialData.debt / (financialData.income * 12)) * 100;
      const emergencyMonths = financialData.savings / financialData.expenses;
      const netWorth = financialData.savings + financialData.investments - financialData.debt;
      
      // Update metric displays
      savingsRateElement.textContent = `${savingsRate.toFixed(1)}%`;
      dtiRatioElement.textContent = `${dtiRatio.toFixed(1)}%`;
      emergencyMonthsElement.textContent = `${emergencyMonths.toFixed(1)} mo`;
      netWorthElement.textContent = `$${netWorth.toLocaleString()}`;
      
      // Style metrics based on health
      styleMetric(savingsRateElement, savingsRate, 20, 10);
      styleMetric(dtiRatioElement, dtiRatio, 36, 43, true);
      styleMetric(emergencyMonthsElement, emergencyMonths, 3, 1);
      styleMetric(netWorthElement, netWorth, 0, -1000);
      
      // Generate insights
      generateInsights(savingsRate, dtiRatio, emergencyMonths, netWorth);
      
      // Render the orb visualization
      renderOrb(savingsRate, dtiRatio, emergencyMonths, netWorth);
      
      // Save to history
      saveToHistory();
    }
    
    // Style metric elements based on value ranges
    function styleMetric(element, value, goodThreshold, warningThreshold, reverse = false) {
      element.classList.remove('metric-good', 'metric-warning', 'metric-danger');
      
      if (reverse) {
        // Lower is better (like debt-to-income)
        if (value <= goodThreshold) {
          element.classList.add('metric-good');
        } else if (value <= warningThreshold) {
          element.classList.add('metric-warning');
        } else {
          element.classList.add('metric-danger');
        }
      } else {
        // Higher is better (like savings rate)
        if (value >= goodThreshold) {
          element.classList.add('metric-good');
        } else if (value >= warningThreshold) {
          element.classList.add('metric-warning');
        } else {
          element.classList.add('metric-danger');
        }
      }
    }
    
    // Generate personalized financial insights
    function generateInsights(savingsRate, dtiRatio, emergencyMonths, netWorth) {
      insightsContainer.innerHTML = '';
      
      const insights = [];
      
      // Savings rate insights
      if (savingsRate < 0) {
        insights.push({
          title: "üö® Spending Exceeds Income",
          message: "Your expenses are higher than your income. Consider reviewing your spending habits and creating a budget."
        });
      } else if (savingsRate < 10) {
        insights.push({
          title: "üìâ Low Savings Rate",
          message: "Your savings rate is below the recommended 10-20%. Look for areas to reduce discretionary spending."
        });
      } else if (savingsRate >= 20) {
        insights.push({
          title: "üìà Excellent Savings Rate",
          message: "You're saving a healthy portion of your income! Consider increasing retirement contributions."
        });
      }
      
      // Debt insights
      if (dtiRatio > 43) {
        insights.push({
          title: "‚ö†Ô∏è High Debt Burden",
          message: "Your debt-to-income ratio is concerning. Focus on paying down high-interest debt first."
        });
      } else if (dtiRatio > 36) {
        insights.push({
          title: "üìä Approaching Debt Limit",
          message: "Your debt level is approaching the recommended maximum. Avoid taking on new debt."
        });
      } else if (dtiRatio === 0) {
        insights.push({
          title: "‚úÖ Debt-Free",
          message: "You have no debt! This puts you in a strong financial position."
        });
      }
      
      // Emergency fund insights
      if (emergencyMonths < 1) {
        insights.push({
          title: "üö® Insufficient Emergency Fund",
          message: "Build an emergency fund covering at least 3 months of expenses as soon as possible."
        });
      } else if (emergencyMonths < 3) {
        insights.push({
          title: "üìã Emergency Fund Building",
          message: "Continue building your emergency fund until you have 3-6 months of expenses covered."
        });
      } else if (emergencyMonths >= 6) {
        insights.push({
          title: "üõ°Ô∏è Strong Safety Net",
          message: "You have a robust emergency fund. Consider redirecting extra savings to investments."
        });
      }
      
      // Net worth insights
      if (netWorth < 0) {
        insights.push({
          title: "üìâ Negative Net Worth",
          message: "Focus on paying down debt to reach a positive net worth as your first financial milestone."
        });
      } else if (netWorth > 0 && netWorth < financialData.income * 6) {
        insights.push({
          title: "üìä Building Wealth",
          message: "You're building a solid financial foundation. Keep increasing your savings and investments."
        });
      } else if (netWorth >= financialData.income * 6) {
        insights.push({
          title: "üí∞ Strong Financial Position",
          message: "You've built significant wealth! Consider speaking with a financial advisor about advanced strategies."
        });
      }
      
      // Render insights
      insights.forEach(insight => {
        const insightElement = document.createElement('div');
        insightElement.className = 'insight-card';
        insightElement.innerHTML = `
          <div class="insight-title">${insight.title}</div>
          <p>${insight.message}</p>
        `;
        insightsContainer.appendChild(insightElement);
      });
      
      // If no insights (unlikely), show a generic message
      if (insights.length === 0) {
        insightsContainer.innerHTML = `
          <div class="insight-card">
            <div class="insight-title">üìä Financial Health Check</div>
            <p>Your financial metrics appear to be in good shape. Continue monitoring and adjusting as needed.</p>
          </div>
        `;
      }
    }
    
    // Render the orb visualization
    function renderOrb(savingsRate, dtiRatio, emergencyMonths, netWorth) {
      // Calculate health score (0-100)
      const healthScore = Math.max(0, Math.min(100, 
        (Math.min(savingsRate, 30) / 30 * 25) + // Savings rate contribution (max 25 points)
        (Math.max(0, 43 - dtiRatio) / 43 * 25) + // Debt contribution (max 25 points)
        (Math.min(emergencyMonths, 6) / 6 * 25) + // Emergency fund contribution (max 25 points)
        (netWorth > 0 ? 25 : Math.min(25, (netWorth + 10000) / 10000 * 25)) // Net worth contribution
      ));
      
      // Determine orb color based on health score
      let color;
      if (healthScore >= 80) color = '#10b981'; // Green
      else if (healthScore >= 60) color = '#f59e0b'; // Yellow
      else if (healthScore >= 40) color = '#f97316'; // Orange
      else color = '#ef4444'; // Red
      
      // Calculate pulse speed (faster pulse = better health)
      const pulseDuration = Math.max(1, Math.min(4, 5 - (healthScore / 25)));
      
      // Calculate rings based on savings rate and emergency fund
      const savingsRings = Math.min(5, Math.floor(savingsRate / 5));
      const emergencyRings = Math.min(3, Math.floor(emergencyMonths / 2));
      
      // Create SVG for orb
      let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <radialGradient id="orbGradient" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="${color}" stop-opacity="0.9"/>
            <stop offset="100%" stop-color="${color}" stop-opacity="0.2"/>
          </radialGradient>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
            <feMerge>
              <feMergeNode in="coloredBlur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        
        <!-- Outer rings for emergency fund -->
        ${Array.from({length: emergencyRings}, (_, i) => {
          const r = 45 + i * 5;
          return `<circle cx="50" cy="50" r="${r}" fill="none" 
                  stroke="${color}" stroke-width="0.8" stroke-opacity="0.4" 
                  stroke-dasharray="2,2"/>`;
        }).join('')}
        
        <!-- Middle rings for savings rate -->
        ${Array.from({length: savingsRings}, (_, i) => {
          const r = 40 + i * 3;
          return `<circle cx="50" cy="50" r="${r}" fill="none" 
                  stroke="${color}" stroke-width="1" stroke-opacity="0.6"/>`;
        }).join('')}
        
        <!-- Main orb -->
        <circle cx="50" cy="50" r="35" fill="url(#orbGradient)" 
                filter="url(#glow)" style="animation: pulse ${pulseDuration}s infinite alternate;">
        </circle>
        
        <!-- Health indicator -->
        <circle cx="50" cy="50" r="30" fill="none" 
                stroke="white" stroke-width="2" stroke-opacity="0.3"/>
        
        <!-- Health score text -->
        <text x="50" y="52" text-anchor="middle" fill="white" 
              font-size="10" font-weight="bold" opacity="0.9">${Math.round(healthScore)}</text>
        
        <style>
          @keyframes pulse {
            from { r: 33; opacity: 0.8; }
            to { r: 37; opacity: 1; }
          }
        </style>
      </svg>`;
      
      orbElement.innerHTML = svg;
    }
    
    // Generate a privacy-safe shareable DNA
    async function shareDNA() {
      if (financialData.income <= 0) {
        alert("Please generate your financial orb first.");
        return;
      }
      
      // Create privacy-safe ranges
      const privacyData = {
        incomeRange: getRange(financialData.income, [2000, 4000, 6000, 8000, 10000]),
        expensesRange: getRange(financialData.expenses, [1000, 2000, 3000, 4000, 5000]),
        debtRange: getRange(financialData.debt, [5000, 10000, 20000, 50000, 100000]),
        savingsRange: getRange(financialData.savings, [1000, 5000, 10000, 20000, 50000]),
        investmentsRange: getRange(financialData.investments, [1000, 5000, 15000, 30000, 50000])
      };
      
      // Generate hash
      const dnaHash = await hashFinancialData(privacyData);
      
      // Create shareable URL
      const shareUrl = `${window.location.origin}${window.location.pathname}#dna=${dnaHash.substring(0,12)}`;
      shareUrlElement.innerText = shareUrl;
      shareUrlElement.style.display = 'block';
      
      // Copy to clipboard
      navigator.clipboard.writeText(shareUrl).then(() => {
        alert("Shareable link copied to clipboard!");
      });
    }
    
    // Render shared DNA (for when someone opens a shared link)
    function renderSharedDNA(dnaHash) {
      // In a real implementation, you would map the DNA hash back to visual parameters
      // For this demo, we'll show a generic visualization
      renderOrb(15, 28, 4.5, 25000);
      
      // Update metrics with placeholders
      savingsRateElement.textContent = "15.0%";
      dtiRatioElement.textContent = "28.0%";
      emergencyMonthsElement.textContent = "4.5 mo";
      netWorthElement.textContent = "$25,000";
      
      // Show shared message
      insightsContainer.innerHTML = `
        <div class="insight-card">
          <div class="insight-title">üîó Shared Financial Health</div>
          <p>This is a privacy-safe representation of someone's financial health. No actual financial data is revealed.</p>
        </div>
      `;
      
      // Show the orb tab
      switchTab('orb');
    }
    
    // Save current snapshot to history
    function saveSnapshot() {
      if (financialData.income <= 0) {
        alert("Please generate your financial orb first.");
        return;
      }
      
      const snapshot = {
        ...financialData,
        timestamp: new Date().toISOString(),
        savingsRate: ((financialData.income - financialData.expenses) / financialData.income) * 100,
        dtiRatio: (financialData.debt / (financialData.income * 12)) * 100,
        emergencyMonths: financialData.savings / financialData.expenses,
        netWorth: financialData.savings + financialData.investments - financialData.debt
      };
      
      history.push(snapshot);
      saveToStorage();
      renderHistoryChart();
      
      alert("Snapshot saved to your financial history!");
    }
    
    // Save to browser storage
    function saveToHistory() {
      const snapshot = {
        ...financialData,
        timestamp: new Date().toISOString()
      };
      
      // Only keep last 12 months of history
      const oneYearAgo = new Date();
      oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
      
      history = history.filter(item => new Date(item.timestamp) > oneYearAgo);
      history.push(snapshot);
      saveToStorage();
    }
    
    // Add a new financial goal
    function addGoal() {
      const goalText = goalInput.value.trim();
      if (!goalText) return;
      
      const goal = {
        id: Date.now(),
        text: goalText,
        completed: false,
        createdAt: new Date().toISOString()
      };
      
      goals.push(goal);
      goalInput.value = '';
      saveToStorage();
      renderGoals();
    }
    
    // Toggle goal completion
    function toggleGoal(id) {
      const goal = goals.find(g => g.id === id);
      if (goal) {
        goal.completed = !goal.completed;
        saveToStorage();
        renderGoals();
      }
    }
    
    // Delete a goal
    function deleteGoal(id) {
      goals = goals.filter(g => g.id !== id);
      saveToStorage();
      renderGoals();
    }
    
    // Render goals list
    function renderGoals() {
      goalsContainer.innerHTML = '';
      
      if (goals.length === 0) {
        goalsContainer.innerHTML = '<p>No goals yet. Add your first financial goal above!</p>';
        return;
      }
      
      goals.forEach(goal => {
        const goalElement = document.createElement('div');
        goalElement.className = 'goal-item';
        goalElement.innerHTML = `
          <div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" ${goal.completed ? 'checked' : ''} 
                     onchange="toggleGoal(${goal.id})">
              <span style="${goal.completed ? 'text-decoration: line-through; color: #9ca3af;' : ''}">
                ${goal.text}
              </span>
            </div>
            <div class="goal-progress">
              <div class="goal-progress-bar" style="width: ${goal.completed ? '100' : '0'}%"></div>
            </div>
          </div>
          <button onclick="deleteGoal(${goal.id})" style="width: auto; background: var(--danger); padding: 8px 12px;">Delete</button>
        `;
        goalsContainer.appendChild(goalElement);
      });
    }
    
    // Render history chart
    function renderHistoryChart() {
      const canvas = document.getElementById('trend-chart');
      const ctx = canvas.getContext('2d');
      
      // Set canvas dimensions
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (history.length < 2) {
        ctx.font = '14px sans-serif';
        ctx.fillStyle = '#6b7280';
        ctx.textAlign = 'center';
        ctx.fillText('Not enough data to show trends', canvas.width / 2, canvas.height / 2);
        return;
      }
      
      // Sort history by date
      const sortedHistory = [...history].sort((a, b) => 
        new Date(a.timestamp) - new Date(b.timestamp)
      );
      
      // Calculate metrics for each snapshot
      const metrics = sortedHistory.map(snapshot => ({
        date: new Date(snapshot.timestamp),
        netWorth: snapshot.savings + snapshot.investments - snapshot.debt,
        savingsRate: ((snapshot.income - snapshot.expenses) / snapshot.income) * 100
      }));
      
      // Find min and max values for scaling
      const netWorthValues = metrics.map(m => m.netWorth);
      const minNetWorth = Math.min(...netWorthValues);
      const maxNetWorth = Math.max(...netWorthValues);
      
      const savingsRateValues = metrics.map(m => m.savingsRate);
      const minSavingsRate = Math.min(...savingsRateValues);
      const maxSavingsRate = Math.max(...savingsRateValues);
      
      // Chart dimensions
      const padding = 40;
      const chartWidth = canvas.width - padding * 2;
      const chartHeight = canvas.height - padding * 2;
      
      // Draw net worth trend line
      ctx.beginPath();
      ctx.strokeStyle = '#2563eb';
      ctx.lineWidth = 3;
      
      metrics.forEach((metric, index) => {
        const x = padding + (index / (metrics.length - 1)) * chartWidth;
        const y = canvas.height - padding - (
          (metric.netWorth - minNetWorth) / (maxNetWorth - minNetWorth || 1)
        ) * chartHeight;
        
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      
      ctx.stroke();
      
      // Draw savings rate trend line (secondary axis)
      ctx.beginPath();
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      
      metrics.forEach((metric, index) => {
        const x = padding + (index / (metrics.length - 1)) * chartWidth;
        const y = canvas.height - padding - (
          (metric.savingsRate - minSavingsRate) / (maxSavingsRate - minSavingsRate || 1)
        ) * chartHeight;
        
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Draw axes
      ctx.strokeStyle = '#d1d5db';
      ctx.lineWidth = 1;
      
      // X-axis
      ctx.beginPath();
      ctx.moveTo(padding, canvas.height - padding);
      ctx.lineTo(canvas.width - padding, canvas.height - padding);
      ctx.stroke();
      
      // Y-axis
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, canvas.height - padding);
      ctx.stroke();
      
      // Add labels
      ctx.font = '12px sans-serif';
      ctx.fillStyle = '#6b7280';
      ctx.textAlign = 'center';
      
      // X-axis label (time)
      ctx.fillText('Time', canvas.width / 2, canvas.height - 10);
      
      // Y-axis label
      ctx.save();
      ctx.translate(15, canvas.height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText('Financial Metrics', 0, 0);
      ctx.restore();
      
      // Legend
      ctx.fillStyle = '#2563eb';
      ctx.fillRect(canvas.width - 120, 20, 15, 15);
      ctx.fillStyle = '#6b7280';
      ctx.textAlign = 'left';
      ctx.fillText('Net Worth', canvas.width - 100, 32);
      
      ctx.fillStyle = '#10b981';
      ctx.fillRect(canvas.width - 120, 45, 15, 15);
      ctx.fillStyle = '#6b7280';
      ctx.fillText('Savings Rate %', canvas.width - 100, 57);
    }
    
    // Clear history
    function clearHistory() {
      if (confirm("Are you sure you want to clear your financial history? This cannot be undone.")) {
        history = [];
        saveToStorage();
        renderHistoryChart();
      }
    }
    
    // Utility functions
    function getRange(value, thresholds) {
      for (let i = 0; i < thresholds.length; i++) {
        if (value <= thresholds[i]) return i;
      }
      return thresholds.length;
    }
    
    async function hashFinancialData(data) {
      const encoder = new TextEncoder();
      const dataStr = JSON.stringify(data);
      const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(dataStr));
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    // Storage functions
    function saveToStorage() {
      localStorage.setItem('finOrbData', JSON.stringify(financialData));
      localStorage.setItem('finOrbGoals', JSON.stringify(goals));
      localStorage.setItem('finOrbHistory', JSON.stringify(history));
    }
    
    function loadFromStorage() {
      const savedData = localStorage.getItem('finOrbData');
      const savedGoals = localStorage.getItem('finOrbGoals');
      const savedHistory = localStorage.getItem('finOrbHistory');
      
      if (savedData) {
        financialData = JSON.parse(savedData);
        document.getElementById('income').value = financialData.income || '';
        document.getElementById('expenses').value = financialData.expenses || '';
        document.getElementById('debt').value = financialData.debt || '';
        document.getElementById('savings').value = financialData.savings || '';
        document.getElementById('investments').value = financialData.investments || '';
      }
      
      if (savedGoals) {
        goals = JSON.parse(savedGoals);
      }
      
      if (savedHistory) {
        history = JSON.parse(savedHistory);
      }
    }
    
    // Handle window resize for chart
    window.addEventListener('resize', renderHistoryChart);
  </script>
</body>
</html>
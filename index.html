<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow | NeuroAdaptTech</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f1f5f9;
            --card-bg: rgba(15, 23, 42, 0.8);
            --card-border: rgba(148, 163, 184, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            transition: background 1s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        header {
            text-align: center;
            padding: 20px 0 40px;
            position: relative;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        
        h1 {
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--primary-light), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }
        
        .tagline {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 15px auto 0;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        /* Cards */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            margin-bottom: 25px;
            color: var(--primary-light);
        }
        
        .card-title i {
            background: rgba(37, 99, 235, 0.15);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Focus Meter */
        .focus-meter-container {
            margin: 30px 0;
        }
        
        .focus-meter-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .focus-meter {
            height: 24px;
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .focus-level {
            height: 100%;
            width: 78%;
            background: linear-gradient(90deg, var(--success), var(--accent));
            border-radius: 12px;
            transition: width 0.8s cubic-bezier(0.22, 0.61, 0.36, 1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            font-weight: bold;
            color: var(--darker);
            font-size: 0.85rem;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 18px 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
            color: var(--primary-light);
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.7;
        }
        
        /* Work Area */
        .work-area {
            margin-top: 25px;
        }
        
        textarea {
            width: 100%;
            height: 180px;
            background: rgba(2, 6, 23, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            color: var(--light);
            font-size: 1rem;
            resize: none;
            transition: all 0.4s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .distracted textarea {
            opacity: 0.4;
            filter: blur(2px);
        }
        
        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        button {
            padding: 16px 20px;
            border: none;
            border-radius: 14px;
            background: rgba(37, 99, 235, 0.15);
            color: var(--primary-light);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        button:hover {
            background: rgba(37, 99, 235, 0.25);
            transform: translateY(-2px);
        }
        
        button.primary {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
        }
        
        /* Camera Feed */
        .camera-feed {
            position: relative;
            margin-top: 20px;
            border-radius: 16px;
            overflow: hidden;
            background: var(--darker);
            border: 1px solid var(--card-border);
        }
        
        video, canvas {
            width: 100%;
            display: block;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            background: var(--dark);
            border-left: 4px solid var(--warning);
            padding: 18px 22px;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transform: translateX(120%);
            transition: transform 0.4s ease;
            max-width: 350px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification h3 {
            color: var(--warning);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
        }
        
        /* Chart */
        .chart-container {
            height: 250px;
            margin-top: 20px;
        }
        
        /* Onboarding */
        .onboarding {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(2, 6, 23, 0.95);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
        
        .onboarding-content {
            max-width: 600px;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }
        
        .onboarding h2 {
            font-size: 2.2rem;
            margin-bottom: 20px;
            color: var(--primary-light);
        }
        
        .onboarding p {
            margin: 15px 0;
            line-height: 1.7;
            opacity: 0.9;
        }
        
        .onboarding-steps {
            text-align: left;
            margin: 25px 0;
        }
        
        .onboarding-step {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-start;
        }
        
        .step-icon {
            background: rgba(37, 99, 235, 0.15);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 3px;
        }
        
        /* Insights Modal */
        .insights-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(2, 6, 23, 0.95);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        
        .insights-modal.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .insights-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.15);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(239, 68, 68, 0.25);
            transform: rotate(90deg);
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .insight-card {
            background: rgba(2, 6, 23, 0.4);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--card-border);
        }
        
        .insight-card h3 {
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-container {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 5px;
        }
        
        .trend-chart {
            height: 120px;
            margin-top: 20px;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.2rem;
            }
            
            .tagline {
                font-size: 1rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .card-title {
                font-size: 1.2rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .onboarding-content {
                padding: 25px;
            }
            
            .onboarding h2 {
                font-size: 1.8rem;
            }
            
            .insights-content {
                padding: 25px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .logo-icon {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px 0 20px;
            font-size: 0.9rem;
            opacity: 0.6;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .privacy-note {
            max-width: 600px;
            margin: 15px auto 0;
            font-size: 0.85rem;
            background: rgba(37, 99, 235, 0.1);
            padding: 12px;
            border-radius: 12px;
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(2, 6, 23, 0.8);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--primary-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Coaching Tips */
        .coaching-tips {
            margin-top: 25px;
            padding: 15px;
            background: rgba(2, 6, 23, 0.3);
            border-radius: 12px;
            border-left: 3px solid var(--accent);
        }
        
        .coaching-tips h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .coaching-tips p {
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        /* Focus Indicator */
        .focus-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success);
            transition: background-color 0.5s ease;
        }
        
        .focus-indicator.distracted {
            background-color: var(--warning);
            box-shadow: 0 0 10px var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        .focus-indicator.lost {
            background-color: var(--danger);
            box-shadow: 0 0 10px var(--danger);
            animation: pulse 0.8s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="loader"></div>
        <p>Loading NeuroAdaptTech engine...</p>
    </div>
    
    <!-- Onboarding Modal -->
    <div class="onboarding" id="onboarding">
        <div class="onboarding-content">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <h1>FocusFlow</h1>
            </div>
            <h2>Welcome to NeuroAdaptTech</h2>
            <p>The next generation of cognitive-adaptive interfaces that respond to your focus in real-time</p>
            
            <div class="onboarding-steps">
                <div class="onboarding-step">
                    <div class="step-icon">
                        <i class="fas fa-video"></i>
                    </div>
                    <div>
                        <h3>Camera Access</h3>
                        <p>Allow camera access for cognitive analysis. We process everything locally - your data never leaves your device.</p>
                    </div>
                </div>
                
                <div class="onboarding-step">
                    <div class="step-icon">
                        <i class="fas fa-gauge-high"></i>
                    </div>
                    <div>
                        <h3>Focus Tracking</h3>
                        <p>Work naturally while we monitor your attention patterns using computer vision and AI.</p>
                    </div>
                </div>
                
                <div class="onboarding-step">
                    <div class="step-icon">
                        <i class="fas fa-wand-magic-sparkles"></i>
                    </div>
                    <div>
                        <h3>Adaptive Interface</h3>
                        <p>Experience an interface that adapts to your cognitive state in real-time to enhance productivity.</p>
                    </div>
                </div>
            </div>
            
            <button id="start-btn" class="primary" style="width: 100%; padding: 18px; margin-top: 20px;">
                <i class="fas fa-play"></i> Start Cognitive Enhancement
            </button>
            
            <p class="privacy-note" style="margin-top: 20px;">
                <i class="fas fa-shield-alt"></i> Privacy First: All processing happens locally on your device. No data is collected or sent to any servers.
            </p>
        </div>
    </div>
    
    <!-- Insights Modal -->
    <div class="insights-modal" id="insights-modal">
        <div class="insights-content">
            <div class="close-btn" id="close-insights">
                <i class="fas fa-times"></i>
            </div>
            
            <div class="logo" style="justify-content: flex-start; margin-bottom: 30px;">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h1 style="font-size: 2.2rem;">Cognitive Insights</h1>
            </div>
            
            <p>Detailed analysis of your focus patterns and productivity metrics</p>
            
            <div class="insights-grid">
                <div class="insight-card">
                    <h3><i class="fas fa-brain"></i> Focus Distribution</h3>
                    <p>Your time spent in different cognitive states</p>
                    
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 65%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Deep Focus: 65%</span>
                        <span>65 min</span>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 25%; background: var(--warning);"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Moderate: 25%</span>
                        <span>25 min</span>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 10%; background: var(--danger);"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Distracted: 10%</span>
                        <span>10 min</span>
                    </div>
                </div>
                
                <div class="insight-card">
                    <h3><i class="fas fa-wave-square"></i> Focus Trends</h3>
                    <p>Your focus patterns throughout the session</p>
                    <div class="trend-chart">
                        <canvas id="trend-chart"></canvas>
                    </div>
                </div>
                
                <div class="insight-card">
                    <h3><i class="fas fa-bolt"></i> Peak Performance</h3>
                    <p>Your most productive time periods</p>
                    
                    <div style="margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>10:30 - 11:15 AM</span>
                            <span>92% Focus</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: 92%"></div>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>2:45 - 3:30 PM</span>
                            <span>87% Focus</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: 87%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="insight-card">
                    <h3><i class="fas fa-lightbulb"></i> Improvement Tips</h3>
                    <p>Personalized recommendations based on your data</p>
                    
                    <div style="margin-top: 20px;">
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start;">
                            <div style="background: rgba(16, 185, 129, 0.15); width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-clock" style="color: var(--success);"></i>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 5px;">Schedule Breaks</h4>
                                <p style="opacity: 0.8;">Take a 5-minute break every 50 minutes to maintain high focus levels</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start;">
                            <div style="background: rgba(37, 99, 235, 0.15); width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-moon" style="color: var(--primary-light);"></i>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 5px;">Morning Focus</h4>
                                <p style="opacity: 0.8;">Your cognitive performance peaks between 9-11 AM - schedule important tasks then</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="container" id="app" style="display: none;">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <h1>FocusFlow</h1>
            </div>
            <p class="tagline">NeuroAdaptTech that dynamically adapts to your cognitive state to maximize productivity</p>
        </header>
        
        <div class="notification" id="notification">
            <h3><i class="fas fa-lightbulb"></i> Cognitive Break Recommended</h3>
            <p>You've been distracted multiple times. Consider a 2-minute break to recharge.</p>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-gauge-high"></i> Cognitive Dashboard</h2>
                
                <div class="focus-meter-container">
                    <div class="focus-meter-labels">
                        <span>Distracted</span>
                        <span>Focused</span>
                    </div>
                    <div class="focus-meter">
                        <div class="focus-level" id="focus-level">78%</div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Distractions</div>
                        <div class="stat-value" id="distraction-count">3</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Focus Time</div>
                        <div class="stat-value" id="focus-time">12:45</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Productivity</div>
                        <div class="stat-value" id="productivity">87%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Sessions</div>
                        <div class="stat-value" id="sessions">5</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="focus-chart"></canvas>
                </div>
                
                <div class="coaching-tips" id="coaching-tips">
                    <h4><i class="fas fa-lightbulb"></i> Focus Tip</h4>
                    <p id="tip-text">Try the Pomodoro technique: 25 minutes of focused work followed by a 5-minute break.</p>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title"><i class="fas fa-face-smile"></i> Cognitive Analysis <div class="focus-indicator" id="focus-indicator"></div></h2>
                
                <div class="camera-feed">
                    <video id="webcam" autoplay playsinline width="640" height="480" style="display:none"></video>
                    <canvas id="output" width="640" height="480"></canvas>
                </div>
                
                <p style="margin-top: 20px; opacity: 0.8; font-size: 0.95rem;">
                    <i class="fas fa-info-circle"></i> Keep your face visible. We're analyzing attention through:
                </p>
                
                <div class="stats-grid" style="margin-top: 15px;">
                    <div class="stat-card">
                        <div class="stat-label">Eye Movement</div>
                        <div class="stat-value" id="eye-metric">92%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Head Position</div>
                        <div class="stat-value" id="head-metric">86%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Engagement</div>
                        <div class="stat-value" id="engagement">79%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card work-area">
            <h2 class="card-title"><i class="fas fa-keyboard"></i> Adaptive Workspace</h2>
            
            <textarea id="work-textarea" placeholder="Start typing here... NeuroAdaptTech will monitor your cognitive engagement and adapt the interface to help maintain your focus flow. Try looking away from the screen to see the adaptation in action."></textarea>
            
            <div class="controls">
                <button id="calibrate-btn">
                    <i class="fas fa-sliders"></i> Calibrate
                </button>
                <button id="pause-btn">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button id="reset-btn">
                    <i class="fas fa-rotate"></i> Reset Session
                </button>
                <button id="insights-btn">
                    <i class="fas fa-chart-line"></i> Insights
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>NeuroAdaptTech MVP | Pioneering the Future of Cognitive Interfaces</p>
            <p class="privacy-note">
                <i class="fas fa-lock"></i> Privacy First: All processing happens locally on your device. No data is collected or sent to any servers.
            </p>
        </div>
    </div>

    <script>
        // Enhanced State Management with session persistence
        const state = {
            focusScore: localStorage.getItem('focusScore') ? parseInt(localStorage.getItem('focusScore')) : 85,
            distractionCount: localStorage.getItem('distractionCount') ? parseInt(localStorage.getItem('distractionCount')) : 0,
            focusStartTime: Date.now(),
            lastKeystrokeTime: 0,
            lastFaceDetectionTime: Date.now(),
            distractionStartTime: 0,
            isCalibrating: false,
            isActive: false,
            faceDetectionCount: 0,
            calibrationData: { eyePositions: [] },
            focusHistory: JSON.parse(localStorage.getItem('focusHistory')) || Array(20).fill(85),
            sessionCount: localStorage.getItem('sessionCount') ? parseInt(localStorage.getItem('sessionCount')) : 5,
            eyeMetric: 92,
            headMetric: 86,
            engagement: 79,
            lastDistractionTime: 0,
            coachingTips: [
                "Try the Pomodoro technique: 25 minutes of focused work followed by a 5-minute break.",
                "Minimize distractions by closing unnecessary tabs and apps.",
                "Stay hydrated - dehydration can reduce cognitive performance by up to 30%.",
                "Practice deep breathing for 2 minutes to reset your focus.",
                "Adjust your environment lighting to reduce eye strain.",
                "Stand up and stretch every 30 minutes to maintain blood flow."
            ],
            currentTipIndex: 0
        };
        
        // DOM Elements
        const dom = {
            focusLevel: document.getElementById('focus-level'),
            distractionCountEl: document.getElementById('distraction-count'),
            focusTimeEl: document.getElementById('focus-time'),
            productivityEl: document.getElementById('productivity'),
            sessionsEl: document.getElementById('sessions'),
            workTextarea: document.getElementById('work-textarea'),
            webcam: document.getElementById('webcam'),
            canvas: document.getElementById('output'),
            notification: document.getElementById('notification'),
            calibrateBtn: document.getElementById('calibrate-btn'),
            pauseBtn: document.getElementById('pause-btn'),
            resetBtn: document.getElementById('reset-btn'),
            insightsBtn: document.getElementById('insights-btn'),
            eyeMetricEl: document.getElementById('eye-metric'),
            headMetricEl: document.getElementById('head-metric'),
            engagementEl: document.getElementById('engagement'),
            app: document.getElementById('app'),
            onboarding: document.getElementById('onboarding'),
            loading: document.getElementById('loading'),
            insightsModal: document.getElementById('insights-modal'),
            closeInsights: document.getElementById('close-insights'),
            focusIndicator: document.getElementById('focus-indicator'),
            coachingTips: document.getElementById('coaching-tips'),
            tipText: document.getElementById('tip-text')
        };
        
        // Initialize Chart
        const focusChart = new Chart(document.getElementById('focus-chart'), {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [{
                    label: 'Focus Level',
                    data: state.focusHistory,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `Focus: ${Math.round(context.parsed.y)}%`
                        }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: 'rgba(255, 255, 255, 0.6)' }
                    },
                    x: { display: false }
                }
            }
        });
        
        // Initialize TensorFlow.js model
        let faceModel;
        async function initModel() {
            try {
                faceModel = await blazeface.load();
                console.log("NeuroAdapt model loaded successfully");
                setTimeout(() => {
                    dom.loading.style.display = 'none';
                    dom.onboarding.style.display = 'flex';
                }, 1500);
            } catch (err) {
                console.error("Error loading model:", err);
                alert("Error loading cognitive analysis model. Please check console for details.");
            }
        }
        
        // Setup webcam
        async function setupWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: 640, height: 480 } 
                });
                dom.webcam.srcObject = stream;
                
                return new Promise((resolve) => {
                    dom.webcam.onloadedmetadata = () => {
                        resolve();
                    };
                });
            } catch (err) {
                console.error("Error accessing webcam:", err);
                alert("Could not access webcam. Please ensure you have a camera connected and permissions granted.");
            }
        }
        
        // Detect cognitive state
        async function detectCognitiveState() {
            if (!faceModel || !state.isActive) return;
            
            try {
                const predictions = await faceModel.estimateFaces(dom.webcam, false);
                const ctx = dom.canvas.getContext('2d');
                
                // Clear canvas and mirror the context for user comfort
                ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
                ctx.save();
                ctx.scale(-1, 1);
                ctx.translate(-dom.canvas.width, 0);
                
                if (predictions.length > 0) {
                    const face = predictions[0];
                    drawFace(face, ctx);
                    
                    // Calculate cognitive metrics
                    const isFacingScreen = checkFacingScreen(face);
                    
                    // Update metrics display
                    state.eyeMetric = Math.min(100, Math.max(70, state.eyeMetric + (isFacingScreen ? 1 : -3)));
                    state.headMetric = Math.min(100, Math.max(70, state.headMetric + (isFacingScreen ? 1 : -2)));
                    state.engagement = Math.min(100, Math.max(60, Math.floor((state.eyeMetric + state.headMetric) / 2)));
                    
                    dom.eyeMetricEl.textContent = `${state.eyeMetric}%`;
                    dom.headMetricEl.textContent = `${state.headMetric}%`;
                    dom.engagementEl.textContent = `${state.engagement}%`;
                    
                    // Update focus score
                    updateFocusScore(isFacingScreen);
                    state.lastFaceDetectionTime = Date.now();
                    state.faceDetectionCount++;
                    
                    // Update focus indicator
                    if (state.focusScore > 75) {
                        dom.focusIndicator.className = 'focus-indicator';
                    } else if (state.focusScore > 50) {
                        dom.focusIndicator.className = 'focus-indicator distracted';
                    } else {
                        dom.focusIndicator.className = 'focus-indicator lost';
                    }
                } else {
                    // No face detected - likely distracted
                    const now = Date.now();
                    if (now - state.lastFaceDetectionTime > 2000) {
                        updateFocusScore(false);
                        
                        // Show distraction indicator
                        dom.focusIndicator.className = 'focus-indicator lost';
                        
                        // Show notification after 5 seconds of distraction
                        if (now - state.lastDistractionTime > 10000) {
                            state.distractionCount++;
                            dom.distractionCountEl.textContent = state.distractionCount;
                            showNotification();
                            state.lastDistractionTime = now;
                        }
                    }
                }
                
                ctx.restore();
            } catch (err) {
                console.error("Cognitive analysis error:", err);
            }
            
            requestAnimationFrame(detectCognitiveState);
        }
        
        // Draw face landmarks
        function drawFace(face, ctx) {
            // Draw bounding box
            const box = face.topLeft.concat(face.bottomRight);
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.strokeRect(box[0], box[1], box[2] - box[0], box[3] - box[1]);
            
            // Draw landmarks
            ctx.fillStyle = '#06b6d4';
            face.landmarks.forEach(point => {
                ctx.beginPath();
                ctx.arc(point[0], point[1], 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw attention indicator
            ctx.fillStyle = state.focusScore > 65 ? '#10b981' : '#f59e0b';
            ctx.beginPath();
            ctx.arc(dom.canvas.width - 30, 30, 10, 0, 2 * Math.PI);
            ctx.fill();
        }
        
        // Check if user is facing the screen
        function checkFacingScreen(face) {
            const nose = face.landmarks[2];
            const leftEye = face.landmarks[0];
            const rightEye = face.landmarks[1];
            
            // Calculate if nose is between eyes
            const minX = Math.min(leftEye[0], rightEye[0]);
            const maxX = Math.max(leftEye[0], rightEye[0]);
            
            return nose[0] > minX && nose[0] < maxX;
        }
        
        // Update focus score
        function updateFocusScore(isFacingScreen) {
            if (state.isCalibrating) return;
            
            const now = Date.now();
            const timeSinceLastKeystroke = state.lastKeystrokeTime ? now - state.lastKeystrokeTime : 0;
            
            // Base score adjustment
            let adjustment = 0;
            
            if (isFacingScreen) {
                adjustment += 1.5;
                state.distractionStartTime = 0;
                
                // Reward active typing
                if (timeSinceLastKeystroke < 2000) {
                    adjustment += 1;
                }
            } else {
                adjustment -= 2;
                
                // Start distraction timer
                if (!state.distractionStartTime) {
                    state.distractionStartTime = now;
                } else if (now - state.distractionStartTime > 5000) {
                    adjustment -= 3;
                }
            }
            
            // Punish long typing pauses
            if (timeSinceLastKeystroke > 5000) {
                adjustment -= 1;
            }
            
            // Apply adjustment with smoothing
            state.focusScore = Math.min(100, Math.max(20, state.focusScore + adjustment * 0.2));
            
            // Update UI and save state
            updateUI();
            saveState();
        }
        
        // Track keystrokes
        function trackKeystrokes() {
            const now = Date.now();
            
            // Detect distraction patterns
            if (state.lastKeystrokeTime && now - state.lastKeystrokeTime > 3000) {
                // Penalize long pauses
                state.focusScore = Math.max(20, state.focusScore - 3);
                updateUI();
                saveState();
            }
            
            // Reward active typing
            state.focusScore = Math.min(100, state.focusScore + 0.5);
            updateUI();
            saveState();
            
            state.lastKeystrokeTime = now;
        }
        
        // Update UI
        function updateUI() {
            // Update focus meter
            dom.focusLevel.style.width = `${state.focusScore}%`;
            dom.focusLevel.textContent = `${Math.round(state.focusScore)}%`;
            
            // Update productivity metric
            const productivity = Math.min(100, Math.max(20, state.focusScore - 5 + Math.random() * 10));
            dom.productivityEl.textContent = `${Math.round(productivity)}%`;
            
            // Update focus time
            const focusSeconds = Math.floor((Date.now() - state.focusStartTime) / 1000);
            const minutes = Math.floor(focusSeconds / 60);
            const seconds = focusSeconds % 60;
            dom.focusTimeEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update session count
            dom.sessionsEl.textContent = state.sessionCount;
            
            // Update distraction count
            dom.distractionCountEl.textContent = state.distractionCount;
            
            // Adapt interface
            document.body.className = state.focusScore > 65 ? '' : 'distracted';
            
            // Update chart
            state.focusHistory.push(state.focusScore);
            if (state.focusHistory.length > 20) state.focusHistory.shift();
            focusChart.data.datasets[0].data = state.focusHistory;
            focusChart.update();
            
            // Rotate coaching tips every 30 seconds
            if (Date.now() - state.lastTipChange > 30000) {
                state.currentTipIndex = (state.currentTipIndex + 1) % state.coachingTips.length;
                dom.tipText.textContent = state.coachingTips[state.currentTipIndex];
                state.lastTipChange = Date.now();
            }
        }
        
        // Save state to localStorage
        function saveState() {
            localStorage.setItem('focusScore', state.focusScore);
            localStorage.setItem('distractionCount', state.distractionCount);
            localStorage.setItem('focusHistory', JSON.stringify(state.focusHistory));
            localStorage.setItem('sessionCount', state.sessionCount);
        }
        
        // Show notification
        function showNotification() {
            dom.notification.classList.add('show');
            setTimeout(() => {
                dom.notification.classList.remove('show');
            }, 5000);
        }
        
        // Calibration process
        function startCalibration() {
            state.isCalibrating = true;
            
            // Create calibration modal
            const calibrationModal = document.createElement('div');
            calibrationModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(2, 6, 23, 0.95);
                z-index: 2000;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                padding: 20px;
            `;
            
            calibrationModal.innerHTML = `
                <div style="background: var(--card-bg); border-radius: 20px; padding: 40px; max-width: 500px;">
                    <h2 style="font-size: 1.8rem; margin-bottom: 20px; color: var(--primary-light);">
                        <i class="fas fa-sliders"></i> Cognitive Calibration
                    </h2>
                    <p style="margin-bottom: 30px; line-height: 1.7;">
                        Please look directly at the screen with a focused expression for 5 seconds. 
                        This helps NeuroAdaptTech optimize for your unique cognitive patterns.
                    </p>
                    <div style="font-size: 3rem; margin: 30px 0;">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <div id="calibration-timer" style="font-size: 2.5rem; font-weight: bold; margin: 20px 0; color: var(--accent);">
                        5s
                    </div>
                    <button id="cancel-calibration" style="padding: 14px 30px; background: rgba(239, 68, 68, 0.15); color: var(--danger); border: none; border-radius: 14px; font-weight: bold; cursor: pointer;">
                        <i class="fas fa-times"></i> Cancel Calibration
                    </button>
                </div>
            `;
            
            document.body.appendChild(calibrationModal);
            
            // Start countdown
            let seconds = 5;
            const timerEl = document.getElementById('calibration-timer');
            const countdown = setInterval(() => {
                seconds--;
                timerEl.textContent = `${seconds}s`;
                
                if (seconds <= 0) {
                    clearInterval(countdown);
                    calibrationComplete();
                }
            }, 1000);
            
            // Cancel button
            document.getElementById('cancel-calibration').addEventListener('click', () => {
                clearInterval(countdown);
                document.body.removeChild(calibrationModal);
                state.isCalibrating = false;
            });
            
            function calibrationComplete() {
                document.body.removeChild(calibrationModal);
                state.isCalibrating = false;
                
                // Show completion notification
                const completeModal = document.createElement('div');
                completeModal.style.cssText = calibrationModal.style.cssText;
                completeModal.innerHTML = `
                    <div style="background: var(--card-bg); border-radius: 20px; padding: 40px; max-width: 500px;">
                        <h2 style="font-size: 1.8rem; margin-bottom: 20px; color: var(--success);">
                            <i class="fas fa-check-circle"></i> Calibration Complete!
                        </h2>
                        <p style="margin-bottom: 30px; line-height: 1.7;">
                            NeuroAdaptTech is now optimized for your cognitive patterns. 
                            You should experience more accurate focus tracking.
                        </p>
                        <div style="font-size: 3rem; margin: 30px 0; color: var(--success);">
                            <i class="fas fa-brain"></i>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="padding: 14px 30px; background: rgba(16, 185, 129, 0.15); color: var(--success); border: none; border-radius: 14px; font-weight: bold; cursor: pointer;">
                            <i class="fas fa-check"></i> Start Working
                        </button>
                    </div>
                `;
                
                document.body.appendChild(completeModal);
            }
        }
        
        // Reset session
        function resetSession() {
            state.focusScore = 85;
            state.distractionCount = 0;
            state.focusStartTime = Date.now();
            state.focusHistory = Array(20).fill(85);
            state.sessionCount++;
            updateUI();
            saveState();
        }
        
        // Start analysis
        async function startAnalysis() {
            dom.onboarding.style.display = 'none';
            dom.app.style.display = 'block';
            
            try {
                state.isActive = true;
                await setupWebcam();
                detectCognitiveState();
                state.lastTipChange = Date.now();
                dom.tipText.textContent = state.coachingTips[0];
            } catch (err) {
                console.error("Start analysis failed:", err);
                state.isActive = false;
            }
        }
        
        // Toggle analysis
        function toggleAnalysis() {
            state.isActive = !state.isActive;
            dom.pauseBtn.innerHTML = state.isActive ? 
                '<i class="fas fa-pause"></i> Pause' : 
                '<i class="fas fa-play"></i> Resume';
                
            if (state.isActive) {
                detectCognitiveState();
            }
        }
        
        // Show insights
        function showInsights() {
            // Initialize trend chart
            const trendCtx = document.getElementById('trend-chart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['9 AM', '10 AM', '11 AM', '12 PM', '1 PM', '2 PM', '3 PM', '4 PM'],
                    datasets: [{
                        label: 'Focus Level',
                        data: [65, 78, 92, 85, 70, 82, 87, 75],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#3b82f6',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: 'rgba(255, 255, 255, 0.6)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.6)' }
                        }
                    }
                }
            });
            
            // Show insights modal
            dom.insightsModal.classList.add('show');
        }
        
        // Event Listeners
        dom.workTextarea.addEventListener('keydown', trackKeystrokes);
        document.getElementById('start-btn').addEventListener('click', startAnalysis);
        dom.calibrateBtn.addEventListener('click', startCalibration);
        dom.resetBtn.addEventListener('click', resetSession);
        dom.pauseBtn.addEventListener('click', toggleAnalysis);
        dom.insightsBtn.addEventListener('click', showInsights);
        dom.closeInsights.addEventListener('click', () => {
            dom.insightsModal.classList.remove('show');
        });
        
        // Close insights when clicking outside content
        dom.insightsModal.addEventListener('click', (e) => {
            if (e.target === dom.insightsModal) {
                dom.insightsModal.classList.remove('show');
            }
        });
        
        // Initialize
        initModel();
        updateUI();
    </script>
</body>
</html>